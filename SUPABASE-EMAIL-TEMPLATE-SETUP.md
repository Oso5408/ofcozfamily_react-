# Supabase Email Template Configuration

## Understanding {{ .ConfirmationURL }}

`{{ .ConfirmationURL }}` is a **Supabase template variable** that automatically generates the password reset link. You don't need to manually set it - Supabase handles this automatically based on your URL configuration.

## Step-by-Step: Configure Password Reset Email

### Step 1: Access Email Templates

1. Go to [Supabase Dashboard](https://app.supabase.com)
2. Select your project
3. Navigate to **Authentication** → **Email Templates**
4. Find the **"Reset Password"** template

### Step 2: Verify Template Content

The default Supabase template should look like this:

```html
<h2>Reset Password</h2>

<p>Follow this link to reset the password for your user:</p>

<p><a href="{{ .ConfirmationURL }}">Reset Password</a></p>
```

**Important:** The `{{ .ConfirmationURL }}` variable is **already there** by default. Don't remove it!

### Step 3: What {{ .ConfirmationURL }} Does

When Supabase sends the email, it **automatically replaces** `{{ .ConfirmationURL }}` with:

```
https://yourdomain.com/#/reset-password#access_token=xxx&type=recovery
```

The URL is built from:
- **Site URL** (set in URL Configuration)
- **Redirect URL** (from your code: `window.location.origin/#/reset-password`)
- **Access token** (generated by Supabase for security)

### Step 4: Configure URL Settings (Required!)

For `{{ .ConfirmationURL }}` to work correctly, you MUST configure:

#### 4a. Set Site URL

1. Go to **Authentication** → **URL Configuration**
2. Set **Site URL**:
   - **Development**: `http://localhost:5173`
   - **Production**: `https://yourdomain.com`

#### 4b. Add Redirect URLs

In the same **URL Configuration** section:

1. Click **Add URL** under "Redirect URLs"
2. Add both:
   ```
   http://localhost:5173/#/reset-password
   https://yourdomain.com/#/reset-password
   ```

### Step 5: Customize Email Template (Optional)

You can customize the email appearance while keeping `{{ .ConfirmationURL }}`:

```html
<!DOCTYPE html>
<html>
<head>
  <style>
    body { font-family: Arial, sans-serif; }
    .button {
      background-color: #f59e0b;
      color: white;
      padding: 12px 24px;
      text-decoration: none;
      border-radius: 6px;
      display: inline-block;
    }
  </style>
</head>
<body>
  <h2>重設密碼 / Reset Password</h2>
  
  <p>您收到此電郵是因為有人要求重設您的密碼。</p>
  <p>You received this email because someone requested a password reset.</p>
  
  <p>
    <a href="{{ .ConfirmationURL }}" class="button">
      重設密碼 / Reset Password
    </a>
  </p>
  
  <p>如果您沒有要求重設密碼，請忽略此電郵。</p>
  <p>If you didn't request this, please ignore this email.</p>
  
  <p>此連結將在24小時後過期。</p>
  <p>This link will expire in 24 hours.</p>
</body>
</html>
```

**Key Points:**
- Keep `{{ .ConfirmationURL }}` in the `href` attribute
- Customize text, styling, and layout around it
- Don't remove or modify the variable itself

## Available Template Variables

Supabase provides several variables you can use:

| Variable | Description | Example |
|----------|-------------|---------|
| `{{ .ConfirmationURL }}` | Full password reset URL with token | `https://yourdomain.com/#/reset-password#access_token=...` |
| `{{ .Token }}` | Just the access token | `eyJhbGciOiJIUzI1...` |
| `{{ .TokenHash }}` | Hashed token | `abc123...` |
| `{{ .SiteURL }}` | Your configured site URL | `https://yourdomain.com` |
| `{{ .Email }}` | User's email address | `user@example.com` |

## Testing the Email Template

### Test Flow:

1. **Trigger Reset**:
   ```bash
   # From your app
   Navigate to: http://localhost:5173/#/forgot-password
   Enter email: testuser@example.com
   Click: Send Reset Link
   ```

2. **Check Email**:
   - Open the email sent to `testuser@example.com`
   - Verify the link contains correct domain
   - Click should redirect to reset password page

3. **Verify URL Format**:
   Expected format:
   ```
   https://yourdomain.com/#/reset-password#access_token=xxx&expires_at=xxx&refresh_token=xxx&token_type=recovery&type=recovery
   ```

## Common Issues

### Issue: Email link goes to localhost in production

**Cause**: Site URL still set to `http://localhost:5173`

**Fix**: Update Site URL to production domain in Supabase → Authentication → URL Configuration

### Issue: "Invalid redirect URL" error

**Cause**: Production URL not in allowed Redirect URLs list

**Fix**: Add `https://yourdomain.com/#/reset-password` to Redirect URLs

### Issue: {{ .ConfirmationURL }} appears as plain text in email

**Cause**: Template syntax error or Supabase not processing template

**Fix**:
1. Check template has `{{ .ConfirmationURL }}` (with double curly braces)
2. Save template and try again
3. If persists, reset to default template and re-customize

### Issue: Email not received at all

**Cause**: Email service not configured or domain not verified

**Fix**:
1. Check Supabase uses built-in email service (or configure SMTP)
2. For production, configure custom SMTP or Resend integration
3. Check spam folder

## Screenshot Locations (Supabase Dashboard)

### 1. Email Templates:
```
Dashboard → Authentication → Email Templates → Reset Password
```

### 2. URL Configuration:
```
Dashboard → Authentication → URL Configuration
- Site URL: [your domain]
- Redirect URLs: [list of allowed URLs]
```

### 3. Email Settings:
```
Dashboard → Project Settings → Auth → SMTP Settings (optional)
```

## Production Checklist

Before going live:

- [ ] Site URL set to production domain
- [ ] Production redirect URL added to allowed list
- [ ] Email template tested with {{ .ConfirmationURL }}
- [ ] Reset password page works on production domain
- [ ] Email delivery confirmed (check inbox + spam)
- [ ] Link format verified (should include production domain)
- [ ] Token expiry tested (24 hours default)

## Example: Complete Production Setup

```
Site URL:
https://ofcozfamily.com

Redirect URLs:
http://localhost:5173/#/reset-password     (for development)
https://ofcozfamily.com/#/reset-password   (for production)

Email Template:
<a href="{{ .ConfirmationURL }}">Reset Password</a>

Generated Link (production):
https://ofcozfamily.com/#/reset-password#access_token=eyJ...&type=recovery
```

---

**Remember:** You don't "set" `{{ .ConfirmationURL }}` - Supabase automatically generates it based on your URL configuration. Just make sure:
1. It exists in your email template ✅
2. Site URL is configured correctly ✅
3. Redirect URLs include your domain ✅
